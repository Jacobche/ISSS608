---
title: "Take-home Exercise 3"
description: |
  In this Take-home Exercise, I will explore the economic of the city of Engagement, Ohio USA.
author:
  - name: Che Xuan 
    url: https://www.linkedin.com/in/jacob-che-xuan-b646a9123/
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.retina = 3)
```


# Task

**Challenge 3: Economic** considers the financial health of the city. Over time, are businesses growing or shrinking? How are people changing jobs? Are standards of living improving or declining over time?

Consider the financial status of Engagementâ€™s businesses and residents, and use visual analytic techniques to address these questions.

- Describe the health of the various employers within the city limits. What employment patterns do you observe? Do you notice any areas of particularly high or low turnover? Limit your response to 10 images and 500 words.

# Overview

In this take-home exercise, appropriate static and interactive statistical graphics methods are used to reveal the economic of the [city of Engagement, Ohio USA](https://vast-challenge.github.io/2022/) while addressing the questions stated in the Task section.

The data are processed by using appropriate **tidyverse** family of packages and the statistical graphics are prepared using **ggplot2** and its extensions.

# Sketch of Proposed Design

The picture below shows a sketch of the initial design proposed. 

![](img/image1.jpg)


# Installing & Launching R Packages

Before we get started, it is important for us to ensure that the required R packages have been installed. If yes, we will load the R packages. If they have yet to be installed, we will install the R packages and load them onto R environment.

The chunk code below will do the trick.

```{r}
packages = c('tidyverse', 'ggdist', 'ggridges', 'patchwork', 'ggthemes', 'lubridate', 'ggiraph', 'gganimate', 'plotly', 'DT', 'crosstalk')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}

library(trelliscopejs)
```

# Importing Data

The code chunk below imports *Participants.csv* from the data folder into R by using [`read_csv()`](https://readr.tidyverse.org/reference/read_delim.html) of [**readr**](https://readr.tidyverse.org/) package and save it as an tibble data frame called *participants*.

```{r}
travel <- read_csv("rawdata/TravelJournal.csv")
employers <- read_csv("rawdata/Employers.csv")

summary(travel)
summary(employers)
```


# Data Wrangling

```{r}
travel$month <- factor(month(travel$`travelEndTime`), 
                    levels=1:12, 
                    labels=month.abb, 
                    ordered=TRUE)
travel$year <- year(travel$`travelEndTime`)
travel$year_month <- format(as.Date(travel$`travelEndTime`), "%Y-%m")
travel$day <- day(travel$`travelEndTime`)
travel$date <- date(travel$`travelEndTime`)
travel$wkday <- weekdays(travel$`travelEndTime`)
```


# Vizualization

First we examine the overall trend of travel for all purpose

```{r}
ggplot(data=travel, 
       aes(x = travelStartTime, 
           fill = purpose)) +
    geom_histogram(bins=15,
                   color="black") +
    scale_y_continuous(NULL,
                     breaks = NULL)
```
Next we use trellis plot to examine changes over time. However since the facet function of ggplot2 is not useful for visualizing large data (i.e. 1000 participants), we will use [**trelliscopejs**](https://hafen.github.io/trelliscopejs/index.html) instead.

```{r}
travel_count <- travel %>%
  select(year_month, purpose, participantId) %>%
  group_by(year_month, purpose) %>%
  summarise(count = n()) %>%
  ungroup()
```




```{r}
qplot(year_month, count, data = travel_count) +
  facet_wrap(~ purpose) +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```

Zooming into Work pattern



```{r}
travel_to_work <- travel %>%
  filter(purpose == 'Work/Home Commute') %>%
  inner_join(y=employers, by = c("travelEndLocationId" = "employerId")) %>%
  select(participantId, travelEndTime, year, year_month, month, day, date, wkday, travelEndLocationId, purpose, location, buildingId) %>%
  rename('employerId' = 'travelEndLocationId')
```


Rename a value for simplicity

```{r}
travel_to_work$purpose <- sub('Work/Home Commute', 
                              'Work',
                              travel_to_work$purpose)
```



doing a count:

```{r}
travel_to_work_count <- travel_to_work %>%
  group_by(year_month, day) %>%
  summarise(count = n()) %>%
  ungroup()
```


by month analysis


```{r fig.width=12, fig.height=6}
ggplot() + 
  geom_line(data=travel_to_work_count,
            aes(x=day, 
                y=count, 
                group=year_month), 
            colour="black") +
  facet_grid(~year_month) +
  labs(axis.text.x = element_blank()) +
  xlab("") +
  ylab("No. of Visitors")
```


```{r}
qplot(day, count, data = travel_to_work_count) +
  facet_wrap(~ year_month) +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())

```



```{r}
qplot(day, count, data = travel_to_work_count) +
  facet_trelliscope(~ year_month, nrow = 2, ncol = 4, width = 600,
                    path = "trellis/",
                    self_contained=TRUE) +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```



Interactive Bar graph by month

```{r}
travel_to_work_by_month <- travel_to_work %>%
  group_by(year_month, purpose) %>%
  summarise(count = n()) %>%
  ungroup()
```


```{r}
travel_to_work_by_month$tooltip <- c(paste0(
  "Purpose = ", travel_to_work_by_month$purpose,
  "\n Count = ", travel_to_work_by_month$count))

p <- ggplot(data=travel_to_work_by_month, 
       aes(x = year_month, y = count)) +
  geom_bar_interactive(aes(tooltip = travel_to_work_by_month$tooltip,
                           data_id = year_month),
                       stat="identity")

girafe(
  ggobj = p,
  width_svg = 12,
  height_svg = 12*0.618
)

          
```






```{r}
travel_to_work_daily_count <- travel_to_work %>%
  group_by(employerId, year_month, day, date, wkday) %>%
  summarise(count = n()) %>%
  ungroup()
```





```{r}
travel_to_work_monthly_change <- travel_to_work_daily_count %>%
  group_by(employerId, year_month) %>%
  summarise(monthly_employees = max(count)) %>%
  mutate(mom_change = coalesce(monthly_employees - lead(monthly_employees),0),
         mom_turnover_rate = coalesce((monthly_employees - lead(monthly_employees))/monthly_employees,0)) %>%
  ungroup()
```



```{r}
travel_to_work_mom <- travel_to_work_monthly_change %>%
  group_by(year_month) %>%
  summarise(avg_turnover = mean(mom_turnover_rate)) %>%
  ungroup()
```


```{r}
travel_to_work_mom$tooltip <- c(paste0(
  "MOM Turnover % =", round(travel_to_work_mom$avg_turnover*100,1), '%'))

p2 <- ggplot(data=travel_to_work_mom, 
       aes(x = year_month, y = avg_turnover)) +
  geom_bar_interactive(aes(tooltip = travel_to_work_mom$tooltip,
                           data_id = year_month),
                       stat="identity")

girafe(code = print(p / p2),
       width_svg = 12,
       height_svg = 12,
       options = list(
         opts_hover(css = "fill: #202020;"),
         opts_hover_inv(css = "opacity:0.2;")
         )
       )
```


<!-- Let's only look at first 2 months: 2022-03 & 2022-04, turnover by day -->

Now look into by wkday

```{r}

wkday_levels <- c('Saturday', 'Friday', 
                  'Thursday', 'Wednesday', 
                  'Tuesday', 'Monday', 
                  'Sunday')

travel_to_work_by_day <- travel_to_work_daily_count %>%
  group_by(date, day, wkday, year_month) %>%
  summarise(daily_employees = sum(count)) %>%
  ungroup() %>%
  mutate(wkday = factor(
    wkday, levels = wkday_levels))
```




```{r}

p3 <- ggplot(travel_to_work_by_day, 
       aes(year_month, 
           wkday, 
           fill = daily_employees)) + 
geom_tile(color = "white", 
          size = 0.1) + 
theme_tufte(base_family = "Helvetica") + 
coord_equal() +
scale_fill_gradient(name = "# of attacks",
                    low = "sky blue", 
                    high = "dark blue")

ggplotly(p3)

```



```{r}
travel_to_work_initial <- travel_to_work_monthly_change %>%
  filter(year_month == '2022-03') %>%
  select(employerId, monthly_employees) %>%
  right_join(y=travel_to_work_monthly_change, by = c("employerId" = "employerId")) %>%
  mutate(strength_level = monthly_employees.y/monthly_employees.x) %>%
  select(employerId, year_month, monthly_employees.y, mom_turnover_rate, strength_level) %>%
  rename('monthly_employees' = 'monthly_employees.y')
```

Rename year_month values to 1-15

```{r}
travel_to_work_initial$year_month <- sub('2022-03', '1', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2022-04', '2', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2022-05', '3', travel_to_work_initial$year_month) 
travel_to_work_initial$year_month <- sub('2022-06', '4', travel_to_work_initial$year_month) 
travel_to_work_initial$year_month <- sub('2022-07', '5', travel_to_work_initial$year_month) 
travel_to_work_initial$year_month <- sub('2022-08', '6', travel_to_work_initial$year_month) 
travel_to_work_initial$year_month <- sub('2022-09', '7', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2022-10', '8', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2022-11', '9', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2022-12', '10', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2023-01', '11', travel_to_work_initial$year_month) 
travel_to_work_initial$year_month <- sub('2023-02', '12', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2023-03', '13', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2023-04', '14', travel_to_work_initial$year_month)
travel_to_work_initial$year_month <- sub('2023-05', '15', travel_to_work_initial$year_month)

travel_to_work_initial <- travel_to_work_initial %>%
  mutate(year_month = as.integer(year_month))
```

animated point plot


```{r}
p5 <- ggplot(travel_to_work_initial, aes(x = mom_turnover_rate, y = strength_level, 
                      size = monthly_employees, 
                      colour = employerId)) +
  geom_point(alpha = 0.7, 
             show.legend = FALSE) +
  # scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  labs(title = 'Year: {frame_time}', 
       x = '% Aged', 
       y = '% Young') +
  transition_time(year_month) +
  ease_aes('linear')

  animate(p5, nframes = 100, fps = 3)
```




